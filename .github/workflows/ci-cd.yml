name: Build → Push → Deploy to GKE

on:
  push:
    branches: [ main ]

env:
  PROJECT_ID: vivid-science-473308-m7       # your project id
  REGION: us-central1                       # artifact registry region
  REPOSITORY: my-repo                       # artifact registry repo
  IMAGE_NAME: iris-api
  GKE_CLUSTER: autopilot-cluster-1
  GKE_LOCATION: us-central1                 # region for Autopilot cluster

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to GCP
        # This authenticates the runner using the service account JSON stored in GitHub Secrets
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up gcloud & kubectl
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: ${{ env.PROJECT_ID }}
          install_components: kubectl

      - name: Configure Docker credential helper for Artifact Registry
        run: |
          # configure-docker accepts <LOCATION>-docker.pkg.dev
          gcloud auth configure-docker ${REGION}-docker.pkg.dev --quiet

      - name: Build and push Docker image
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          REGION: ${{ env.REGION }}
          REPOSITORY: ${{ env.REPOSITORY }}
          IMAGE_NAME: ${{ env.IMAGE_NAME }}
        run: |
          SHORT_SHA=${GITHUB_SHA::7}
          IMAGE_URI="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${IMAGE_NAME}:${SHORT_SHA}"
          echo "IMAGE_URI=${IMAGE_URI}" >> $GITHUB_ENV
          echo "Building ${IMAGE_URI}"
          docker build -t "${IMAGE_URI}" .
          docker push "${IMAGE_URI}"

      - name: Get GKE credentials
        env:
          PROJECT_ID: ${{ env.PROJECT_ID }}
          GKE_CLUSTER: ${{ env.GKE_CLUSTER }}
          GKE_LOCATION: ${{ env.GKE_LOCATION }}
        run: |
          # For Autopilot/regional clusters, use --region; for zonal use --zone
          gcloud container clusters get-credentials "${GKE_CLUSTER}" --region "${GKE_LOCATION}" --project "${PROJECT_ID}"

      - name: Apply k8s manifests (ensure resources exist)
        run: |
          kubectl apply -f k8s/deployment.yaml || true
          kubectl apply -f k8s/service.yaml || true

      - name: Update deployment image and wait for rollout
        run: |
          # IMAGE_URI was exported to GITHUB_ENV earlier
          kubectl set image deployment/iris-deployment iris-api="${IMAGE_URI}" --record
          kubectl rollout status deployment/iris-deployment --timeout=180s

      - name: Show service info
        run: |
          kubectl get pods -l app=iris -o wide || true
          kubectl get svc iris-service -o wide || true
